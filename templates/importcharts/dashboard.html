{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block content %}

<h1 class="h3 mb-3"><strong>Imports</strong> Dashboard</h1>
<div class="card card-body">
	<h1 class="h3 mb-3"><strong>Countries Weight</strong></h1>
	<div class="pt-3 pb-2 mb-3 border-bottom">
		<form id="barchart-filters" class="row g-3">

			{% csrf_token %}
			<div class="col-md-6">
				<label for="year" class="form-label">Years:</label>
				<select name="year" id="year" class='form-control'  multiple="multiple">
					{% for year in years %}
						<option value="{{ year }}">{{ year }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-6">
				<label for="country" class="form-label">Countries:</label>
				<select name="country" id="country" class='form-control'  multiple="multiple">
					{% for country in countries %}
						<option value="{{ country|index:0  }}">{{ country|index:1 }}</option>
					{% endfor %}
				</select>
			</div>

			<div class="col-md-6">
				<label for="description" class="form-label">Product Description:</label>
				<select name="description" id="description" class='form-control'  multiple="multiple">
					{% for description in descriptions %}
						<option value="{{ description }}">{{ description }}</option>
					{% endfor %}
				</select>
			</div>
		</form>
	</div>
	<canvas id="barchart" height='400px'></canvas>
</div>

<div class="card card-body">
	<h1 class="h3 mb-3"><strong>Countries Weight</strong></h1>
	<div class="pt-3 pb-2 mb-3 border-bottom">
		<form id="linechart-filters" class="row g-3">

			{% csrf_token %}
			<div class="col-md-6">
				<label for="countryL" class="form-label">Countries:</label>
				<select name="countryL" id="countryL" class='form-control'  multiple="multiple">
					{% for countryL in countries %}
						<option value="{{ countryL|index:0  }}">{{ countryL|index:1 }}</option>
					{% endfor %}
				</select>
			</div>

			<div class="col-md-6">
				<label for="descriptionL" class="form-label">Product Description:</label>
				<select name="descriptionL" id="descriptionL" class='form-control'  multiple="multiple">
					{% for descriptionL in descriptions %}
						<option value="{{ descriptionL }}">{{ descriptionL }}</option>
					{% endfor %}
				</select>
			</div>
		</form>
	</div>
	<canvas id="lineChartchart" height='400px'></canvas>
	<div class='my-4'>
		<label for="date-slider">Select Date Range:</label>
		<input type="text" id="date-slider" name="date-range" />
	</div>
</div>

<div class="card card-body">
	<h1 class="h3 mb-3"><strong>Countries Weight</strong></h1>
	<div class="pt-3 pb-2 mb-3 border-bottom">
		<form id="piechart-filters" class="row g-3">

			{% csrf_token %}
			<div class="col-md-6">
				<label for="yearP" class="form-label">Years:</label>
				<select name="yearP" id="yearP" class='form-control' >
					{% for yearP in years %}
						<option value="{{ yearP }}">{{ yearP }}</option>
					{% endfor %}
				</select>
			</div>
			{% comment %} <div class="col-md-6">
				<label for="countryP" class="form-label">Countries:</label>
				<select name="countryP" id="countryP" class='form-control'  multiple="multiple">
					{% for countryP in countries %}
						<option value="{{ countryP|index:0  }}">{{ countryP|index:1 }}</option>
					{% endfor %}
				</select>
			</div> {% endcomment %}

			<div class="col-md-6">
				<label for="descriptionP" class="form-label">Product Description:</label>
				<select name="descriptionP" id="descriptionP" class='form-control'  multiple="multiple">
					{% for descriptionP in descriptions %}
						<option value="{{ descriptionP }}">{{ descriptionP }}</option>
					{% endfor %}
				</select>
			</div>
		</form>
	</div>
	{% comment %} <canvas id="piechart" height='400px'></canvas> {% endcomment %}
	<div id="price-chart" style="height: 600px;"></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ion-rangeslider/2.3.1/js/ion.rangeSlider.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.2/dist/echarts.min.js"></script>
<script>

	$(document).ready(function() {
		var dateRange = $('#date-slider');
		$('#country').select2();
		$('#year').select2();
		$('#description').select2();

		$('#countryL').select2();
		$('#descriptionL').select2();

		$('#countryP').select2();
		$('#yearP').select2();
		$('#descriptionP').select2();

		var priceChart;

		$("#date-slider").ionRangeSlider({
      type: "double",
      grid: true,
      min: new Date(`{{ date_range.min }}`).getTime(),
      max: new Date(`{{ date_range.max }}`).getTime(),
      from: new Date(`{{ date_range.min }}`).getTime(),
      to: new Date(`{{ date_range.max }}`).getTime(),
      prettify: function(num) {
        var d = new Date(num);
        var year = d.getFullYear();
        var month = d.getMonth() + 1;
        var day = d.getDate();
        return day + "/" + month + "/" + year;
      },

			onFinish : function(data) {

				var selectedDescriptions = $('#descriptionL').val();
				var selectedCountries = $('#countryL').val();

				var data = {
					'descriptions': selectedDescriptions,
					'countries': selectedCountries,
					'startDate': data.from_pretty,
					'endDate': data.to_pretty
				};

				$.ajax({
					url: "{% url 'importchart:linechart_data' %}",
					data: data,
					success: function (data) {

						// Update the chart data and options with the response data
						lineChart.data = data.data;
						lineChart.options = data.options;

						// Redraw the chart
						lineChart.update();
					},
					error: function (xhr, status, error) {
						console.error("AJAX error:", status, error);
					},
				});
			}
    });

		var barCtx = document.getElementById('barchart').getContext('2d');


		var barChart = new Chart(barCtx, {
			type: 'horizontalBar',
			data: {},
			options: {
				scales: {
				xAxes: [{
					ticks: {
						beginAtZero: true
					}
				}]
				}
			}
		});


		var lineCtx = document.getElementById('lineChartchart').getContext('2d');

    var lineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Price',
          data: [],
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'month'
            }
          }
        }
      }
    });

		/*
		var pieCtx = document.getElementById('piechart').getContext('2d');

    var pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: [],
        datasets: [{
          label: '2003',
          data: [],
          backgroundColor: 'rgba(54, 162, 235, 0.2)',
        }]
      }
    });*/

		$("#year,  #description, #country ").on("change", function () {
			var selectedYears = $('#year').val();
			var selectedDescriptions = $('#description').val();
			var selectedCountries = $('#country').val();

			var data = {
				'years': selectedYears,
				'descriptions': selectedDescriptions,
				'countries': selectedCountries,
			};

			$.ajax({
				url: "{% url 'importchart:barchart_data' %}",
				data: data,
				success: function (data) {
					console.log(data)
					barChart.data = data;
					barChart.update();
				},
				error: function (xhr, status, error) {
					console.error("AJAX error:", status, error);
				},
			});


		});

		var priceChart = echarts.init(document.getElementById('price-chart'));

		$("#yearP,  #descriptionP ").on("change", function () {
			var selectedYear = $('#yearP').val();
			var selectedDescriptions = $('#descriptionP').val();
			var selectedCountries = $('#countryP').val();

			var data = {
				'year': selectedYear,
				'descriptions': selectedDescriptions,
				'countries': selectedCountries,
				'animal_id':{{animal_id}}
			};

			$.ajax({
				url: "{% url 'importchart:piechart_data_echart' %}",
				data: data,
				success: function (data) {
					console.log(data)
					var option = {
						title: {
								text: 'Total Weight (tons) Chart',
								left: 'left',
								top: 30
						},
						tooltip: {
								trigger: 'item',
								formatter: "{a} <br/>{b}: {c} ({d}%)<br/>"
						},
						label: {
							formatter: '{a|{a}}{abg|}\n{hr|}\n  {b|{b}ï¼š}{c}  {per|{d}%}  ',
							backgroundColor: '#F6F8FC',
							borderColor: '#8C8D8E',
							borderWidth: 1,
							borderRadius: 4,
							rich: {
								a: {
									color: '#6E7079',
									lineHeight: 20,
									align: 'center'
								},
								hr: {
									borderColor: '#8C8D8E',
									width: '100%',
									borderWidth: 1,
									height: 0
								},
								b: {
									color: '#4C5058',
									fontSize: 14,
									fontWeight: 'bold',
									lineHeight: 33
								},
								per: {
									color: '#fff',
									backgroundColor: '#4C5058',
									padding: [3, 4],
									borderRadius: 4
								}
							}
						},

						legend: {
								orient: 'vertical',
								left: 'right',
								data: data.data.labels
						},
						series: [
								{
										name: 'Total Weight',
										type: 'pie',
										radius: ['35%', '60%'],
										center: ['50%', '60%'],
										data: data.data.seriesData,
										itemStyle: {
												emphasis: {
														shadowBlur: 10,
														shadowOffsetX: 0,
														shadowColor: 'rgba(0, 0, 0, 0.5)'
												}
										},
										encode: {
												value: 1,
												tooltip: [1, 2]
										}
								}
						]
				};

				priceChart.setOption(option);
					/*
					pieChart.data = data.data;
					pieChart.update();

					if (priceChart) {
						priceChart.destroy();
					}

					var ctx = $('#piechart');
					priceChart = new Chart(ctx, {
							type: 'pie',
							data: data.data
					});*/
				},
				error: function (xhr, status, error) {
					console.error("AJAX error:", status, error);
				},
			});


		});

		$("  #descriptionL, #countryL ").on("change", function () {
			var dateRangeVar = dateRange.data("ionRangeSlider").result;
			var selectedDescriptions = $('#descriptionL').val();
			var selectedCountries = $('#countryL').val();

			var data = {
				'descriptions': selectedDescriptions,
				'countries': selectedCountries,
				'startDate': dateRangeVar.from_pretty,
				'endDate': dateRangeVar.to_pretty
			};


			$.ajax({
				url: "{% url 'importchart:linechart_data' %}",
				data: data,
				success: function (data) {

					// Update the chart data and options with the response data
					lineChart.data = data.data;
					lineChart.options = data.options;

					// Redraw the chart
					lineChart.update();
				},
				error: function (xhr, status, error) {
					console.error("AJAX error:", status, error);
				},
			});


		});

	})

</script>

{% endblock %}